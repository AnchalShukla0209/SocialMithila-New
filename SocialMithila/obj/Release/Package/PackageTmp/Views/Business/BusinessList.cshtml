
@{
    ViewBag.Title = "BusinessList";
    Layout = "~/Views/Shared/LayoutPage.cshtml";
}

<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<!-- main content -->
<div class="main-content right-chat-active">

    <div class="middle-sidebar-bottom">
        <div class="middle-sidebar-left pe-0 ms-0 me-0" style="max-width: 100%;">
            <div class="row">
                <div class="col-xl-12  chat-left scroll-bar">
                    <div class="card shadow-xss w-100 d-block d-flex border-0 p-4 mb-3">
                        <div class="card-body d-flex align-items-center p-0">
                            <h2 class="fw-700 mb-0 mt-0 font-md text-grey-900">Business Details</h2>
                            <div class="search-form-2 ms-auto">

                            </div>
                            <a href="javascript:void(0);" id="filterBtn" class="btn-round-md ms-2 bg-greylight theme-dark-bg rounded-3"><i id="filterBtn" class="feather-filter font-xss text-grey-500"></i></a>
                        </div>
                    </div>
                    <div class="row ps-2 pe-2">
                        <div id="shopContainer" style="display:flex">

                        </div>
                        @*<div class="col-lg-4 col-md-4 col-sm-4 mb-3 pe-2 ps-2">
                            <div class="card w-100 p-0 hover-card shadow-xss border-0 rounded-3 overflow-hidden me-1">

                                <div class="card-image w-100 mb-3">
                                    <a href="default-hotel-details.html" class="position-relative d-block"><img src="~/asset/images/480x320.jpg" alt="image" class="w-100"></a>
                                </div>
                                <div class="card-body pt-0">

                                    <h4 class="fw-700 font-xss mt-0 lh-28 mb-0"><a href="default-hotel-details.html" class="text-dark text-grey-900">Montana Hotel</a></h4>
                                    <h6 class="font-xsssss text-grey-500 fw-600 mt-0 mb-2"> 323 Geldenfe Ave Park, Flodia City</h6>
                                    <div class="star d-block w-100 text-left mt-0">
                                        <img src="~/asset/images/star.png" alt="star" class="w15 me-1 float-left">
                                        <img src="~/asset/images/star.png" alt="star" class="w15 me-1 float-left">
                                        <img src="~/asset/images/star.png" alt="star" class="w15 me-1 float-left">
                                        <img src="~/asset/images/star.png" alt="star" class="w15 me-1 float-left">
                                        <img src="~/asset/images/star-disable.png" alt="star" class="w15 me-1 float-left me-2">
                                    </div>

                                    <a href="#" class="position-absolute bottom-15 mb-2 right-15"><i class="btn-round-sm bg-primary-gradiant text-white font-sm feather-chevron-right"></i></a>
                                </div>
                            </div>
                        </div>*@


                    </div>

                    <div id="paginationContainer" class="d-flex justify-content-end align-items-center mb-4" style="padding:5px"></div>
                </div>


            </div>
        </div>

    </div>
</div>

<!-- Overlay -->
<div class="filter-overlay"></div>

<!-- Filter Popup -->
<div class="filter-panel" id="filterPanel">
    <div class="filter-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Filter Options</h5>
        <button class="btn btn-sm btn-light" id="closeFilter">&times;</button>
    </div>

    <div class="filter-body">
        <div class="mb-0">
            <label for="category" class="form-label">Category Name</label>
            <select class="form-control"  id="category"></select>

        </div>

        <div class="mb-0">
            <label for="subcategory" class="form-label">Sub Category Name</label>
            <select class="form-control" multiple="multiple" id="subcategory"></select>

        </div>

        <div class="mb-0">
            <label for="shop" class="form-label">Shop Name</label>
            <select id="shop" class="form-control" multiple="multiple" style="width:100%"></select>
        </div>

        <div class="mb-0">
            <label for="rating" class="form-label">By Rating</label>
            <select id="rating" class="form-select" multiple="multiple">
                <option value="">Select Rating</option>
                <option value="5">5 Stars</option>
                <option value="4">4 Stars</option>
                <option value="3">3 Stars</option>
                <option value="2">2 Stars</option>
                <option value="1">1 Star</option>
            </select>
        </div>

        <div class="mb-0">
            <label for="follower" class="form-label">By Follower Name</label>
            <select id="follower" class="form-control" multiple="multiple" style="width:100%"></select>
        </div>

    </div>

    <div class="filter-footer">
        <button class="btn btn-reset" id="resetFilter">Reset</button>
        <button class="btn btn-search" id="applyFilter">Search</button>
    </div>
</div>

<style>
    /* Backdrop overlay */
    .filter-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.4);
        z-index: 1040;
    }

    /* Right side popup */
    .filter-panel {
        position: fixed;
        top: 0;
        right: -400px;
        width: 350px;
        height: 100%;
        background: #fff;
        box-shadow: -4px 0 15px rgba(0,0,0,0.2);
        transition: all 0.4s ease;
        z-index: 1050;
        overflow-y: auto;
        border-radius: 15px 0 0 15px;
    }

        .filter-panel.open {
            right: 0;
        }

    .filter-header {
        padding: 15px 20px;
        background: #b7015d !important;
        color: white !important;
        border-radius: 15px 0 0 0;
    }

        .filter-header h5 {
            color: white !important
        }

    .filter-body {
        padding: 20px;
    }

        .filter-body label {
            font-weight: 600;
            margin-top: 10px;
        }

    .filter-footer {
        display: flex;
        justify-content: space-between;
        padding: 15px 20px;
        border-top: 1px solid #ddd;
        background: #f9f9f9;
    }

    .btn-search {
        background: #b7015d !important;
        color: white;
        font-weight: 600;
    }

    .btn-reset {
        background-color: #f0f0f0;
        color: #333;
        font-weight: 600;
    }

    .form-control {
        height: 40px !important;
        line-height: 25px !important;
    }

    .shop-thumb {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        object-fit: cover;
        margin-right: 8px;
    }

    .shop-name {
        vertical-align: middle;
    }

    .select2-results__option {
        display: flex;
        align-items: center;
    }

    .shop-thumb-selected {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        object-fit: cover;
        margin-right: 5px;
    }

    @@media (max-width: 576px) {
        .filter-panel {
            width: 100%;
            border-radius: 0;
        }
    }
</style>
<!-- main content -->

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.1.0-rc.0/css/select2.min.css" rel="stylesheet" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.1.0-rc.0/js/select2.min.js"></script>


<script>


    var jq = jQuery.noConflict();
    jq('#subcategory').select2({
        placeholder: "Select options",
        allowClear: true,
        width: '100%'
    });
    jq('#category').select2();
    jq('#rating').select2({
        placeholder: "Select Rating",
        allowClear: true,
        width: '100%'
    });
    jq('#shop').select2({
        placeholder: "Select Shop(s)",
        allowClear: true,
        width: '100%',
        templateResult: formatShopOption,
        templateSelection: formatShopSelection
    });

    jq('#follower').select2({
        placeholder: "Select follower(s)",
        allowClear: true,
        width: '100%',
        templateResult: formatFollowerOption,
        templateSelection: formatFollowerSelection,
        escapeMarkup: function (m) { return m; } // allow html
    });


    jq(document).ready(function () {

       
        jq("#filterBtn").click(function () {
            $(".filter-overlay").fadeIn();
            $("#filterPanel").addClass("open");
        });

        jq("#closeFilter, .filter-overlay, #resetFilter, #applyFilter").click(function () {
            $(".filter-overlay").fadeOut();
            $("#filterPanel").removeClass("open");
        });

        jq("#resetFilter").click(function () {
            $("input, select").val("");
        });
        loadFilteredBusinesses(1);
        loadCategories();
        loadShops();
        loadFollowers(); 
        function loadCategories() {
            jq.ajax({
                url: '/Business/GetCategories',
                type: 'GET',
                dataType: 'json',
                success: function (categories) {
                    let options = '<option value="0" >Select Category</option>';
                    if (categories.success) {

                        jq.each(categories.data, function (i, c) {
                            options += `<option value="${c.CategoryId}">${c.CategoryName}</option>`;
                        });
                    }
                    else {
                        options = '<option value="">Select Category</option>';
                    }
                    jq('#category').html(options);
                },
                error: function (xhr) {
                    console.error("Error loading categories:", xhr);
                }
            });
        }

        jq(document).on('change', '#category', function () {
            let selectedCategories = jq(this).val();

            // Make sure it's always an array
            if (!Array.isArray(selectedCategories)) {
                selectedCategories = selectedCategories ? [selectedCategories] : [];
            }

            // Convert strings to numbers
            selectedCategories = selectedCategories.map(Number);

            if (selectedCategories.length > 0) {
                jq.ajax({
                    url: '/Business/GetSubCategory',
                    type: 'POST',
                    contentType: 'application/json; charset=utf-8',
                    data: JSON.stringify(selectedCategories),
                    dataType: 'json',
                    success: function (subs) {
                        let options = '';
                        if (subs.success && subs.data.length > 0) {
                            jq.each(subs.data, function (i, s) {
                                options += `<option value="${s.SubCategoryId}">${s.SubCategoryName}</option>`;
                            });
                        } else {
                            options = '<option value="">No Sub Categories Found</option>';
                        }

                        jq('#subcategory').html(options).trigger('change'); // refresh select2
                    },
                    error: function (xhr) {
                        console.error("Error loading subcategories:", xhr);
                    }
                });
            } else {
                jq('#subcategory').html('<option value="">Select Sub Category</option>').trigger('change');
            }
        });


        function loadShops() {
            jq.ajax({
                url: '/Business/GetShops',
                type: 'GET',
                dataType: 'json',
                success: function (res) {
                    if (res.success && res.data.length > 0) {
                        jq('#shop').empty();
                        jq.each(res.data, function (i, shop) {
                            jq('#shop').append(
                                `<option data-image="${shop.ImageUrl}" value="${shop.BusinessId}">${shop.BusinessName}</option>`
                            );
                        });
                    } else {
                        jq('#shop').html('<option value="">No shops available</option>');
                    }
                },
                error: function (xhr) {
                    console.error("Error loading shops:", xhr);
                }
            });
        }

        function loadFollowers(businessId) {
            var url = '/Business/GetFollowers?businessId=null';
            
            jq.ajax({
                url: url,
                type: 'GET',
                dataType: 'json',
                success: function (res) {
                    if (res && res.success && res.data && res.data.length > 0) {
                        jq('#follower').empty();
                        jq.each(res.data, function (i, user) {
                            // data-image attribute used in templates
                            jq('#follower').append(
                                `<option data-image="${user.ImageUrl}" value="${user.Id}">${htmlEncode(user.FullName)}</option>`
                            );
                        });
                        // trigger change so select2 shows options
                        jq('#follower').trigger('change');
                    } else {
                        jq('#follower').empty();
                    }
                },
                error: function (xhr) {
                    console.error("Error loading followers:", xhr);
                }
            });
        }

        

        window.renderShopCards = function(data) {
            let html = '';
            jq.each(data, function (i, shop) {
                html += `
        <div class="col-lg-4 col-md-4 col-sm-4 mb-3 pe-2 ps-2">
            <div class="card w-100 p-0 hover-card shadow-xss border-0 rounded-3 overflow-hidden me-1">
                <div class="card-image w-100 mb-3">
                    <a href="/Business/BusinessDetails/${shop.BusinessId}" class="position-relative d-block">
                        <img src="${shop.ImageUrl}" alt="image" class="w-100" />
                    </a>
                </div>
                <div class="card-body pt-0">
                    <h4 class="fw-700 font-xss mt-0 lh-28 mb-0">
                        <a href="/Business/Details/${shop.BusinessId}" class="text-dark text-grey-900">${htmlEncode(shop.BusinessName)}</a>
                    </h4>
                    <h6 class="font-xsssss text-grey-500 fw-600 mt-0 mb-2">${htmlEncode(shop.Address || '')}</h6>
                    <div class="star d-block w-100 text-left mt-0">
                        ${getStars(shop.Rating)}
                    </div>
                    <a href="/Business/BusinessDetails/${shop.BusinessId}" class="position-absolute bottom-15 mb-2 right-15">
                        <i class="btn-round-sm bg-primary-gradiant text-white font-sm feather-chevron-right"></i>
                    </a>
                </div>
            </div>
        </div>`;
            });
            jq('#shopContainer').html(html);
            
        }

        window.getPaginationHtml =function(currentPage, totalPages) {
            let paginationHtml = '<nav><ul class="pagination pagination-sm mb-0" style="padding:10px">';

            // ⏮ Previous button
            if (currentPage === 1)
                paginationHtml += '<li class="page-item disabled"><a class="page-link">Previous</a></li>';
            else
                paginationHtml += `<li class="page-item"><a class="page-link" href="#" onclick="loadFilteredBusinesses(${currentPage - 1})">Previous</a></li>`;

            // Determine visible page range (2 before and 2 after current)
            let start = Math.max(1, currentPage - 2);
            let end = Math.min(totalPages, currentPage + 2);

            // "1" button with ellipsis
            if (start > 1) {
                paginationHtml += `<li class="page-item"><a class="page-link" href="#" onclick="loadFilteredBusinesses(1)">1</a></li>`;
            }
            if (start > 2) {
                paginationHtml += '<li class="page-item disabled"><a class="page-link">...</a></li>';
            }

            // Page buttons
            for (let i = start; i <= end; i++) {
                if (i === currentPage)
                    paginationHtml += `<li class="page-item active"><a class="page-link" href="#">${i}</a></li>`;
                else
                    paginationHtml += `<li class="page-item"><a class="page-link" href="#" onclick="loadFilteredBusinesses(${i})">${i}</a></li>`;
            }

            // Ellipsis before last page if needed
            if (end < totalPages - 1) {
                paginationHtml += '<li class="page-item disabled"><a class="page-link">...</a></li>';
            }
            // Last page button
            if (end < totalPages) {
                paginationHtml += `<li class="page-item"><a class="page-link" href="#" onclick="loadFilteredBusinesses(${totalPages})">${totalPages}</a></li>`;
            }

            // ⏭ Next button
            if (currentPage === totalPages || totalPages === 0)
                paginationHtml += '<li class="page-item disabled"><a class="page-link">Next</a></li>';
            else
                paginationHtml += `<li class="page-item"><a class="page-link" href="#" onclick="loadFilteredBusinesses(${currentPage + 1})">Next</a></li>`;

            paginationHtml += '</ul></nav>';
            return paginationHtml;
        }


        function getStars(rating) {
            let fullStars = Math.floor(rating);
            let html = '';
            for (let i = 1; i <= 5; i++) {
                html += `<img src="${i <= fullStars ? '/asset/images/star.png' : '/asset/images/star-disable.png'}" alt="star" class="w15 me-1 float-left">`;
            }
            return html;
        }

        jq(document).on('click', '#applyFilter', function () {
            loadFilteredBusinesses(1);
        });

        jq(document).on('click', '#resetFilter', function () {
            jq("#category, #subcategory, #shop, #rating, #follower")
                .val(null)
                .trigger('change');

            loadFilteredBusinesses(1);
        });

    });

    function formatShopOption(option) {
        if (!option.id) {
            return option.text;
        }
        var imageUrl = jq(option.element).data('image');
        var imgTag = imageUrl
            ? `<img src="${imageUrl}" class="shop-thumb" />`
            : `<img src="https://cdn-icons-png.flaticon.com/512/407/407861.png" class="shop-thumb" />`;

        var $option = jq(
            `<span>${imgTag}<span class="shop-name">${option.text}</span></span>`
        );
        return $option;
    }

    function formatShopSelection(option) {
        var imageUrl = jq(option.element).data('image');
        var imgTag = imageUrl
            ? `<img src="${imageUrl}" class="shop-thumb-selected" />`
            : '';
        return jq(`<span>${imgTag} ${option.text}</span>`);
    }

    function formatFollowerOption(option) {
        if (!option.id) { return option.text; }
        var imageUrl = jq(option.element).data('image') || 'https://cdn-icons-png.flaticon.com/512/149/149071.png';
        var markup = `
            <div style="display:flex;align-items:center;">
                <img src="${imageUrl}" style="width:36px;height:36px;border-radius:50%;object-fit:cover;margin-right:8px;" />
                <span>${htmlEncode(option.text)}</span>
            </div>`;
        return markup;
    }

    // Template for selected items (in the selection box)
    function formatFollowerSelection(option) {
        if (!option.id) { return option.text; }
        var imageUrl = jq(option.element).data('image') || 'https://cdn-icons-png.flaticon.com/512/149/149071.png';
        var markup = `<span style="display:inline-flex;align-items:center;"><img src="${imageUrl}" style="width:20px;height:20px;border-radius:50%;object-fit:cover;margin-right:6px;" />${htmlEncode(option.text)}</span>`;
        return markup;
    }

    // Simple HTML encoder to avoid injection
    function htmlEncode(str) {
        return String(str || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }

    window.loadFilteredBusinesses = function (page = 1) {
        const filter = {
            CategoryId: $('#category').val() ? parseInt($('#category').val()) : null,
            SubCategoryIds: ($('#subcategory').val() || []).map(Number),
            ShopIds: ($('#shop').val() || []).map(Number),
            Ratings: ($('#rating').val() || []).map(Number),
            FollowerIds: ($('#follower').val() || []).map(Number),
            Page: page
        };

        jq.ajax({
            url: '/Business/GetBusinesses',
            type: 'POST',
            contentType: 'application/json; charset=utf-8',
            data: JSON.stringify(filter),
            dataType: 'json',
            success: function (res) {
                if (res.success) {
                    renderShopCards(res.data);
                    jq('#paginationContainer').html(getPaginationHtml(res.page, res.totalPages));
                } else {
                    jq('#shopContainer').html('<p class="text-danger">No shops found.</p>');
                }
            },
            error: function (xhr) {
                console.error('Error loading businesses:', xhr);
            }
        });
    }

</script>
